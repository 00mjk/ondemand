#!/bin/env ruby

#
# ood_auth_map
#
# Specification
# 1. Must accept a single argument that is URL encoded.
# 2. If successful at mapping user, must return ONLY the user name to `stdout`.
# 3. If unsuccessful at mapping, must return empty string to `stdout`.
#

require 'uri'
require 'date'

module OodAuthMap
  VERSION = '0.0.1'
end

#
# Parse arguments
#

if ARGV[0] == "-v"
  puts "ood_auth_map v#{OodAuthMap::VERSION}"
  exit
elsif ARGV[0]
  auth_user = URI.unescape ARGV[0]
else
  abort 'No arguments supplied!'
end

#
# Use grid-mapfile
#

GRID_MAPFILE='/etc/grid-security/grid-mapfile'

# Don't slurp file
sys_user = nil
File.foreach(GRID_MAPFILE) do |line|
  if matches = %r[^"#{Regexp.quote auth_user}" (\w+)$].match(line)
    sys_user = matches[1]
    break
  end
end

# Print sys_user or empty string
if sys_user
  puts sys_user
  STDERR.puts %[#{DateTime.now} - ood_auth_map: Successfully mapped "#{auth_user}" => "#{sys_user}"]
else
  puts ""
  STDERR.puts %[#{DateTime.now} - ood_auth_map: Failed to map "#{auth_user}"]
end

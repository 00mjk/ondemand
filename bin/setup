#!/usr/bin/env ruby
require "pathname"
require "fileutils"

include FileUtils

ENV["RAILS_ENV"]               ||= ENV["PASSENGER_APP_ENV"] || "production"
ENV["RAILS_RELATIVE_URL_ROOT"] ||= ENV["PASSENGER_BASE_URI"]

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

# path to your application root.
APP_ROOT = Pathname.new File.expand_path("../../",  __FILE__)

# application settings
OOD_ENV    = ENV["RAILS_ENV"]
OOD_URL    = ENV["RAILS_RELATIVE_URL_ROOT"]
OOD_SITE   = ENV["OOD_SITE"]
OOD_PORTAL = ENV["OOD_PORTAL"]

chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file:

  puts "== Building Dashboard App =="
  puts "RAILS_ENV               = #{OOD_ENV}"
  puts "RAILS_RELATIVE_URL_ROOT = #{OOD_URL    || "not set (default: defined in dotenv file)"}"
  puts "OOD_SITE                = #{OOD_SITE   || "not set (default: none)"}"
  puts "OOD_PORTAL              = #{OOD_PORTAL || "not set (default: none)"}"

  puts "\n== Installing dependencies =="
  system("bin/bundle check &> /dev/null") || system!("bin/bundle install --deployment")
  system! "bin/bundle clean"

  if OOD_SITE && OOD_PORTAL
    puts "\n== Enabling portal specific settings =="
    system!("cp .env.local.#{OOD_SITE}.#{OOD_PORTAL} .env.local")
    system!("cp config/initializers/ood.rb.#{OOD_SITE}.#{OOD_PORTAL} config/initializers/ood.rb")
  else
    puts "\n== Ignoring portal specific settings =="
    system!("rm -f .env.local")
    system!("rm -f config/initializers/ood.rb")
  end

  if ENV["RAILS_ENV"] == "production"
    puts "\n== Compiling assets =="
    system! "bin/rake assets:clobber"
    system! "bin/rake assets:precompile"
  end

  puts "\n== Removing old logs and tempfiles =="
  system! "bin/rake log:clear tmp:clear"

  puts "\n== Restarting application server =="
  system! "touch tmp/restart.txt"
end

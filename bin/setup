#!/usr/bin/env ruby
require "pathname"
require "rake"

include FileUtils

# path to your application root.
APP_ROOT = Pathname.new File.expand_path("../../",  __FILE__)

# application settings
DEFAULT_SSHHOST = ENV["DEFAULT_SSHHOST"]

chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file:

  if File.exist?(".env")
    value = `bash -c 'source .env && echo $DEFAULT_SSHHOST'`.strip
    OLD_SSHHOST = value.empty? ? nil : value
    $stderr.puts <<-EOT.gsub(/^ {6}/, "")
      \n\e[31m[DEPRECATION] =================================================
      The file

          #{APP_ROOT.join(".env")}

      is being deprecated. Please specify the DEFAULT_SSHHOST in
      '/etc/ood/config/apps/shell/config.yml' as:

          # /etc/ood/config/apps/shell/config.yml
          ---
          default_host: "#{DEFAULT_SSHHOST || OLD_SSHHOST || "localhost"}"

      then delete the '.env' file.
      ===============================================================\e[0m
    EOT
  else
    OLD_SSHHOST = nil
    $stderr.puts <<-EOT.gsub(/^ {6}/, "") if DEFAULT_SSHHOST
      \n\e[31m[DEPRECATION] =================================================
      The default ssh host should not be specified by the
      environment variable DEFAULT_SSHHOST anymore. Please
      specify it in '/etc/ood/config/apps/shell/config.yml'
      as:

          # /etc/ood/config/apps/shell/config.yml
          ---
          default_host: "#{DEFAULT_SSHHOST}"

      ===============================================================\e[0m\n
    EOT
  end

  puts "\n== Building Shell App =="
  puts "DEFAULT_SSHHOST = #{DEFAULT_SSHHOST || OLD_SSHHOST || "localhost"}"

  puts "\n== Installing dependencies =="
  sh "npm install"
  sh "npm prune"

  if DEFAULT_SSHHOST && DEFAULT_SSHHOST != OLD_SSHHOST
    puts "\n== Setting default ssh host =="
    sh "echo 'DEFAULT_SSHHOST=#{DEFAULT_SSHHOST}' > .env"
  end

  puts "\n== Restarting application server =="
  touch "tmp/restart.txt"
  puts ""
end

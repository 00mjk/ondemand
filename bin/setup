#!/usr/bin/env ruby
require "pathname"
require "fileutils"

include FileUtils

ENV["RAILS_ENV"]               ||= ENV["PASSENGER_APP_ENV"]
ENV["RAILS_RELATIVE_URL_ROOT"] ||= ENV["PASSENGER_BASE_URI"]

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

# path to your application root.
APP_ROOT = Pathname.new File.expand_path("../../",  __FILE__)

chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file:

  puts "== Building Dashboard App =="
  puts "RAILS_ENV               = #{ENV["RAILS_ENV"]}"
  puts "RAILS_RELATIVE_URL_ROOT = #{ENV["RAILS_RELATIVE_URL_ROOT"]}"

  puts "\n== Installing dependencies =="
  system("bin/bundle check &> /dev/null") || system!("bin/bundle install --deployment")
  system! "bin/bundle clean"

  if ENV["RAILS_ENV"] == "production"
    puts "\n== Compiling assets =="
    system! "bin/rake assets:clobber"
    system! "bin/rake assets:precompile"
  end

  puts "\n== Removing old logs and tempfiles =="
  system! "bin/rake log:clear tmp:clear"

  puts "\n== Restarting application server =="
  system! "touch tmp/restart.txt"
end

#!/usr/bin/env ruby
require "pathname"
require "rake"

include FileUtils

ENV["RAILS_ENV"]               ||= ENV["PASSENGER_APP_ENV"] || "production"
ENV["RAILS_RELATIVE_URL_ROOT"] ||= ENV["PASSENGER_BASE_URI"]

# path to your application root.
APP_ROOT = Pathname.new File.expand_path("../../",  __FILE__)

# application settings
OOD_ENV    = ENV["RAILS_ENV"]
OOD_URL    = ENV["RAILS_RELATIVE_URL_ROOT"]
OOD_SITE   = ENV["OOD_SITE"]
OOD_PORTAL = ENV["OOD_PORTAL"]

chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file:

  puts "\n== Building Dashboard App =="
  puts "RAILS_ENV               = #{OOD_ENV}"
  puts "RAILS_RELATIVE_URL_ROOT = #{OOD_URL    || "not set (default: defined in dotenv file)"}"
  puts "OOD_SITE                = #{OOD_SITE   || "not set (default: none)"}"
  puts "OOD_PORTAL              = #{OOD_PORTAL || "not set (default: none)"}"

  unless system("bin/bundle check &> /dev/null")
    puts "\n== Installing dependencies =="
    sh "bin/bundle install --deployment"
    sh "bin/bundle clean"
  end

  if OOD_SITE && OOD_PORTAL
    puts "\n== Enabling portal specific settings =="
    cp ".env.local.#{OOD_SITE}.#{OOD_PORTAL}", ".env.local"
    cp "config/initializers/ood.rb.#{OOD_SITE}.#{OOD_PORTAL}", "config/initializers/ood.rb"
  else
    puts "\n== Ignoring portal specific settings =="
    puts "WARNING: found portal specific file .env.local" if File.exist?(".env.local")
    puts "WARNING: found portal specific file config/initializers/ood.rb" if File.exist?("config/initializers/ood.rb")
  end

  if OOD_ENV == "production"
    puts "\n== Compiling assets =="
    sh "bin/rake assets:clobber"
    sh "bin/rake assets:precompile"
  end

  puts "\n== Removing old logs and tempfiles =="
  sh "bin/rake log:clear tmp:clear"

  puts "\n== Restarting application server =="
  touch "tmp/restart.txt"
  puts ""
end

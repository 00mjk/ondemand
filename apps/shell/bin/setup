#!/usr/bin/env ruby
require "pathname"
require "rake"
require "yaml"

include FileUtils

# path to your application root.
APP_ROOT = Pathname.new File.expand_path("../../",  __FILE__)

# Set Whitelist env variable
whitelist = []
if ENV['SSHHOST_WHITELIST']
  whitelist = ENV['SSHHOST_WHITELIST'].split(':')
end

# Determine sshhosts from cluster config files
sshhost = []
Dir.glob('/etc/ood/config/clusters.d/*.y*ml') do |config_file|
  file = YAML.load_file(config_file)
  if file.has_key?('v2')
    v2 = file['v2']
    if (v2.has_key?('metadata')) #check for hidden attribute in metadata
      metadata = v2['metadata']
      if metadata['hidden'] 
        next #if true, skip to next config file
      end
    end

    if (v2.has_key?('login')) #Skip over file if no login info
      login = v2['login']
      host = login['host']
      default = login['default']
      if default
        sshhost.unshift(host)
      else
        sshhost << host
      end
    end
  else
    puts "#{config_file} does not follow config schema v2. See osc.github.io/ood-documentation for more details"
  end
end

# Determine default sshhost
if ENV["DEFAULT_SSHHOST"]
  DEFAULT_SSHHOST = ENV["DEFAULT_SSHHOST"]
  whitelist << DEFAULT_SSHHOST
else
  DEFAULT_SSHHOST = sshhost[0] #default sshhost at the beginning of array
end

# Add cluster and DEFAULT_SSHHOST to whitelist and remove duplicates
whitelist = whitelist.concat(sshhost).uniq.join(':')

chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file:

  if File.exist?(".env")
    value = `bash -c 'source .env && echo $DEFAULT_SSHHOST'`.strip
    OLD_SSHHOST = value.empty? ? nil : value
    $stderr.puts <<-EOT.gsub(/^ {6}/, "")
      \n\e[31m[DEPRECATION] =================================================
      The file

          #{APP_ROOT.join(".env")}

      is being deprecated. Please move this file to:

          /etc/ood/config/apps/shell/env

      and delete this '.env' file.
      ===============================================================\e[0m
    EOT
  else
    OLD_SSHHOST = nil
    $stderr.puts <<-EOT.gsub(/^ {6}/, "") if DEFAULT_SSHHOST
      \n\e[31m[DEPRECATION] =================================================
      The default ssh host should not be specified by the
      environment variable DEFAULT_SSHHOST during build time
      anymore. Instead please specify it in:

          /etc/ood/config/apps/shell/env

      An example file would look like:

          # /etc/ood/config/apps/shell/env
          DEFAULT_SSHHOST="#{DEFAULT_SSHHOST}"

      ===============================================================\e[0m\n
    EOT
  end

  puts "\n== Building Shell App =="
  puts "DEFAULT_SSHHOST = #{DEFAULT_SSHHOST || OLD_SSHHOST}"

  puts "\n== Installing dependencies =="
  rm_rf "node_modules"
  sh "npm install"

  if DEFAULT_SSHHOST != OLD_SSHHOST
    puts "\n== Setting default ssh host =="
    sh "echo 'DEFAULT_SSHHOST=#{DEFAULT_SSHHOST}' > .env"
  end

  sh "echo 'SSHHOST_WHITELIST=#{whitelist}' >> .env"

  puts "\n== Restarting application server =="
  touch "tmp/restart.txt"
  puts ""
end
